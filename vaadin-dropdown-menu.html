<!--
@license
Copyright (c) 2017 Vaadin Ltd.
This program is available under Apache License Version 2.0, available at https://vaadin.com/license/
-->

<link rel="import" href="../polymer/polymer-element.html">
<link rel="import" href="../vaadin-themable-mixin/vaadin-themable-mixin.html">
<link rel="import" href="../vaadin-overlay/vaadin-overlay.html">
<link rel="import" href="../vaadin-text-field/vaadin-text-field.html">

<dom-module id="vaadin-dropdown-menu-overlay-styles" theme-for="vaadin-dropdown-menu-overlay">
  <template>
    <style>
      :host {
        align-items: flex-start;
        justify-content: flex-start;
      }

      [part~="overlay"] {
        min-width: 175px;
      }

      :host([phone]) {
        top: 0 !important;
        right: 0 !important;
        bottom: 0 !important;
        left: 0 !important;
        padding: 24px;
        align-items: stretch;
        justify-content: flex-end;
      }
    </style>
  </template>
</dom-module>

<dom-module id="vaadin-dropdown-menu-overlay">
  <script>
    {
      /**
        * The overlay element.
        *
        * ### Styling
        *
        * See [`<vaadin-overlay>` documentation](https://github.com/vaadin/vaadin-overlay/blob/master/vaadin-overlay.html)
        * for `<vaadin-dropdown-menu-overlay>` parts.
        *
        * @memberof Vaadin
        */
      class VaadinDropdownMenuOverlayElement extends Vaadin.OverlayElement {
        static get is() {
          return 'vaadin-dropdown-menu-overlay';
        }
      }
      customElements.define(VaadinDropdownMenuOverlayElement.is, VaadinDropdownMenuOverlayElement);
    }
  </script>
</dom-module>

<dom-module id="vaadin-dropdown-menu">
  <template>
    <style>
      :host {
        display: inline-block;
      }
    </style>

    <vaadin-text-field readonly value="[[value]]" id="input"></vaadin-text-field>
    <vaadin-dropdown-menu-overlay opened="{{opened}}" id="overlay">
    </vaadin-dropdown-menu-overlay>
  </template>

  <script>
    {
      /**
        * `<vaadin-dropdown-menu>` is a Polymer 2 element for selecting values from a list of items.
        *
        * ```
        * <vaadin-dropdown-menu>
        *  <template>
        *  </template>
        * </vaadin-dropdown-menu>
        * ```
        *
        * @memberof Vaadin
        * @demo demo/index.html
        */
      class VaadinDropdownMenuElement extends Vaadin.ThemableMixin(Polymer.Element) {
        static get is() {
          return 'vaadin-dropdown-menu';
        }

        static get properties() {
          return {
            opened: {
              type: Boolean,
              value: false,
              notify: true
            },

            _contentTemplate: Object,

            value: {
              type: String,
              value: '',
              notify: true
            }
          };
        }

        static get observers() {
          return ['_openedChanged(opened)'];
        }

        ready() {
          super.ready();

          this.inputElement.addEventListener('click', e => this._toggleOverlay());
          this.inputElement.addEventListener('keydown', e => this._onKeyDown(e));
        }


        _onKeyDown(e) {
          if (!this.opened && /^(ArrowDown|Down|ArrowUp|Up|Enter|Space)$/.test(e.code)) {
            e.preventDefault();
            this._toggleOverlay();
          }
        }

        _onKeyDownInside(e) {
          const menu = this.$.overlay.$.content.lastElementChild;
          const eventFromSelected = e.composedPath()[0].hasAttribute('selected');

          const focusListener = e => {
            const itemToFocus = this.value ? menu._navItems.filter(item => item.textContent === this.value)[0] : menu._navItems[0];
            if (itemToFocus) {
              itemToFocus.focus();
            }

            this.inputElement.removeEventListener('focus', focusListener);
          }

          if ((e.type === 'keydown' && /^(Enter|Space)$/.test(e.code) || e.type === 'click') && eventFromSelected) {
            if (this.value === '') {
              this.value = e.composedPath()[0].textContent;
            }
            this.opened = false;
          } else if (e.type === 'keydown' && /^(Tab)$/.test(e.code)) {
            this.inputElement.focus();
            this.inputElement.addEventListener('focus', focusListener);
          }
        }

        _openedChanged(opened) {
          if (opened && !this._instance) {
            this._contentTemplate = this.querySelector('template');
            const Templatizer = Polymer.Templatize.templatize(this._contentTemplate, this, {
              instanceProps: {
                detail: true,
                target: true
              },
              forwardHostProp: function(prop, value) {
                if (this._instance) {
                  this._instance.forwardHostProp(prop, value);
                }
              }
            });
            this._instance = new Templatizer({});
            this.overlayElement.content = this._instance.root;
          }

          this.overlayElement.opened = opened;

          let menu = this.$.overlay.$.content.lastElementChild;
          const selectedChangedListener = (e) => {
            const selectedItem = menu._navItems[e.detail.value];
            this.value = selectedItem ? selectedItem.textContent : '';

            this.opened = false;
          };

          if (opened) {
            if (!menu || !menu._navItems) {
              return;
            }

            menu.addEventListener('selected-changed', selectedChangedListener);
            menu.addEventListener('keydown', this._onKeyDownInside.bind(this));
            menu.addEventListener('click', this._onKeyDownInside.bind(this));

            const itemToFocus = this.value ? menu._navItems.filter(item => item.textContent === this.value)[0] : menu._navItems[0];
            if (itemToFocus) {
              itemToFocus.focus();
            }
          } else {
            if (menu && menu._navItems) {
              menu.removeEventListener('selected-changed', selectedChangedListener);
              menu.removeEventListener('keydown', this._onKeyDownInside.bind(this));
              menu.removeEventListener('click', this._onKeyDownInside.bind(this));
              this.inputElement.focus();
            }
          }
        }

        _toggleOverlay() {
          this.opened = !this.opened;
          const inputRect = this.inputElement.getBoundingClientRect();

          this.overlayElement.style.left = inputRect.left + 'px';
          this.overlayElement.style.top = (inputRect.top > window.innerHeight - inputRect.top) ?
            this.overlayElement.style.top = inputRect.bottom - this.overlayElement.$.overlay.offsetHeight + 'px' : inputRect.top + 'px';
        }

        get overlayElement() {
          return this.$.overlay;
        }

        get inputElement() {
          return this.$.input;
        }
      }

      customElements.define(VaadinDropdownMenuElement.is, VaadinDropdownMenuElement);

      /**
        * @namespace Vaadin
        */
      window.Vaadin = window.Vaadin || {};
      Vaadin.DropdownMenuElement = VaadinDropdownMenuElement;
    }
  </script>
</dom-module>
